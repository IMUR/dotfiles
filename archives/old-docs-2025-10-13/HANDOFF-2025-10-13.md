# Session Handoff: 2025-10-13

**Session Focus**: Migration planning and backup organization for cooperator transition from Debian SD to Raspberry Pi OS USB

---

## Summary of Work Completed

### 1. Migration Planning Documents Created

Three comprehensive migration documents were created to support the transition from Debian on SD card to Raspberry Pi OS on USB drive:

#### A. Comprehensive Migration Guide
**File**: `docs/MIGRATION-DEBIAN-TO-RASPIOS.md` (10,500+ words)
- Complete 7-phase migration plan
- Detailed procedures for each phase
- Risk assessment and mitigation strategies
- Rollback procedures
- Timeline: 6-8 hours spread across 3 days

#### B. Quick Reference Checklist
**File**: `docs/MIGRATION-CHECKLIST.md`
- Printable checklist format
- Phase-by-phase checkboxes
- Quick rollback procedure
- Emergency contacts and UUIDs
- One-page reference guide

#### C. Minimal Downtime Strategy
**File**: `docs/MINIMAL-DOWNTIME-MIGRATION.md` (8,000+ words)
- **Target**: < 15 minutes downtime
- Pre-deployment strategy (2 hours, zero downtime)
- Quick cutover procedure
- Current system analysis with all running services
- Service dependency mapping

### 2. Backup Directory Structure Created

Organized backup structure for essential configuration files:

**Directory**: `backups/`
```
backups/
├── README.md                  # Comprehensive backup documentation
├── .gitignore                 # Protects sensitive files
├── ORGANIZATION-PLAN.md       # Backup organization strategy
│
├── dns/
│   ├── ism.la.txt            # ✅ GoDaddy zone file (already moved here)
│   └── duckdns/
│       └── duckdns.md        # DuckDNS documentation (user created)
│
├── pihole/
│   ├── teleporter/           # For Pi-hole Teleporter exports
│   ├── custom-lists/
│   └── dns-records/
│
├── services/
│   ├── caddy/
│   ├── docker/
│   ├── systemd/
│   ├── n8n/
│   └── semaphore/
│
├── configs/
│   ├── network/
│   ├── fstab/
│   └── ssh/
│
└── exports/
    ├── state-exports/
    ├── live-configs/
    └── migration/
```

### 3. Backup Documentation

#### A. Backup Directory Documentation
**File**: `backups/README.md`
- Purpose and structure of each subdirectory
- What to commit to git vs. what to exclude
- Backup and restore procedures
- Integration with state files
- Security considerations

#### B. Backup Structure Guide
**File**: `docs/BACKUP-STRUCTURE.md`
- Overview of backup organization
- Files already organized (DNS zone file)
- Usage examples
- Backup checklist for major changes
- Relationship to schema-first approach

#### C. Backup Organization Plan
**File**: `backups/ORGANIZATION-PLAN.md`
- Analysis of existing `etc/` directory
- Clarification that `etc/` IS the Pi-hole Teleporter export
- Git strategy for backups
- Update procedures

### 4. System Analysis Completed

**Current System Configuration Documented**:
- All running services identified and analyzed
- Service dependencies mapped
- Port bindings documented
- Storage configuration analyzed
- Network configuration captured
- Custom systemd units catalogued

**Key Findings**:
- 9 critical services running
- All data safely on `/cluster-nas` (separate NVMe)
- Service restart time: ~45 seconds total
- Boot device: 955GB SD (23GB used)
- Target: 256GB USB with pre-installed Raspberry Pi OS

---

## Files Created This Session

### Migration Documents
1. **`docs/MIGRATION-DEBIAN-TO-RASPIOS.md`** - Comprehensive migration guide
2. **`docs/MIGRATION-CHECKLIST.md`** - Printable checklist
3. **`docs/MINIMAL-DOWNTIME-MIGRATION.md`** - Minimal downtime strategy

### Backup System
4. **`backups/README.md`** - Backup directory documentation
5. **`backups/.gitignore`** - Git ignore rules for backups
6. **`backups/ORGANIZATION-PLAN.md`** - Backup organization plan
7. **`docs/BACKUP-STRUCTURE.md`** - Backup structure guide

### Handoff
8. **`HANDOFF-2025-10-13.md`** - This document

---

## Current Repository State

### Directory Structure
```
crtr-config/
├── docs/                      # Documentation
│   ├── MIGRATION-DEBIAN-TO-RASPIOS.md      # NEW
│   ├── MIGRATION-CHECKLIST.md              # NEW
│   ├── MINIMAL-DOWNTIME-MIGRATION.md       # NEW
│   └── BACKUP-STRUCTURE.md                 # NEW
│
├── backups/                   # Organized backups (NEW)
│   ├── README.md              # NEW
│   ├── .gitignore             # NEW
│   ├── ORGANIZATION-PLAN.md   # NEW
│   ├── dns/
│   │   ├── ism.la.txt         # ✅ GoDaddy zone (moved here)
│   │   └── duckdns/
│   │       └── duckdns.md     # User created
│   ├── pihole/
│   ├── services/
│   ├── configs/
│   └── exports/
│
├── etc/                       # Pi-hole Teleporter export (existing)
│   ├── pihole/
│   ├── dnsmasq.d/
│   └── hosts
│
├── state/                     # Schema-first state files (existing)
│   ├── services.yml
│   ├── domains.yml
│   ├── network.yml
│   └── node.yml
│
└── config/                    # Generated configs (existing)
```

### Files Already in Place
- ✅ GoDaddy DNS zone file: `backups/dns/ism.la.txt`
- ✅ Pi-hole Teleporter export: `etc/` directory
- ✅ State files: `state/*.yml`
- ✅ DuckDNS documentation: `backups/dns/duckdns/duckdns.md`

---

## Key Decisions Made

### 1. Backup Organization
- **Decision**: Keep `etc/` as Pi-hole Teleporter export (as-is)
- **Rationale**: That's exactly what Teleporter export provides
- **Result**: `etc/` directory preserved in original structure

### 2. Migration Strategy
- **Primary**: Minimal downtime approach (< 15 minutes)
- **Alternative**: Comprehensive approach (6-8 hours) available
- **Key Insight**: Pre-deploy everything on USB while SD still serves traffic

### 3. Backup Structure
- **`backups/`**: Organized exports and snapshots
- **`etc/`**: Pi-hole Teleporter export (direct copy)
- **`state/`**: Schema-first source of truth (unchanged)

---

## Next Steps

### Immediate (Before Migration)
1. [ ] Review migration documents
2. [ ] Schedule maintenance window (15 minutes for minimal downtime)
3. [ ] Verify `/cluster-nas` backups are current
4. [ ] Test USB drive is bootable (Phase 0.3 in migration guide)

### Migration Preparation
1. [ ] Follow `docs/MINIMAL-DOWNTIME-MIGRATION.md` Phase 0
2. [ ] Complete pre-deployment on USB (2 hours, zero downtime)
3. [ ] Verify all services on USB before cutover

### During Migration
1. [ ] Use `docs/MIGRATION-CHECKLIST.md` for execution
2. [ ] Follow minimal downtime procedure (15 minutes)
3. [ ] Keep SD card intact for instant rollback

### Post-Migration
1. [ ] Run verification procedures (Phase 2)
2. [ ] Monitor for 24 hours
3. [ ] Update state files with new OS info
4. [ ] Create USB system backup

---

## Important Notes

### Migration Safety
- **SD card stays untouched** - Perfect rollback option
- **Data on separate NVMe** - Zero risk to `/cluster-nas`
- **5-minute rollback** - Just change boot order in BIOS
- **Tested approach** - USB system prepared before cutover

### Backup Strategy
- **`etc/`** = Pi-hole Teleporter export (don't modify structure)
- **`backups/`** = Organized snapshots and external configs
- **`state/`** = Schema-first source of truth
- **Git**: Only commit non-sensitive, non-large files

### File Organization
- ✅ DNS zone file organized: `backups/dns/ism.la.txt`
- ✅ Pi-hole export: `etc/` directory (as-is from Teleporter)
- ✅ Backup structure created and documented
- ✅ .gitignore protects sensitive files

---

## Resources for Migration

### Primary Documents
1. **Quick Start**: `docs/MIGRATION-CHECKLIST.md`
2. **Minimal Downtime**: `docs/MINIMAL-DOWNTIME-MIGRATION.md`
3. **Comprehensive Guide**: `docs/MIGRATION-DEBIAN-TO-RASPIOS.md`

### Reference Documents
- **System Reference**: `COOPERATOR-ASPECTS.md`
- **Repository Guide**: `CLAUDE.md`
- **Getting Started**: `START-HERE.md`

### Backup References
- **Backup Guide**: `backups/README.md`
- **Backup Structure**: `docs/BACKUP-STRUCTURE.md`
- **Organization Plan**: `backups/ORGANIZATION-PLAN.md`

---

## Migration Timeline Options

### Option 1: Minimal Downtime (Recommended)
- **Pre-work**: 2 hours (zero downtime)
- **Cutover**: 15 minutes (downtime)
- **Verification**: 1 hour (services running)
- **Total user impact**: 15 minutes

### Option 2: Comprehensive
- **Phase 0-2**: 2 hours (Day 1)
- **Phase 3-4**: 4 hours (Day 2)
- **Phase 5-7**: 2 hours (Day 3)
- **Total**: 6-8 hours spread across 3 days

---

## System Configuration Summary

### Current (SD Card - Debian 13)
- **Boot**: 955GB microSD (mmcblk0p2)
- **OS**: Debian 13 (Trixie)
- **Usage**: 23GB used / 939GB available
- **Services**: All operational

### Target (USB - Raspberry Pi OS)
- **Boot**: 256GB USB 3.2.2 (sdb2)
- **OS**: Raspberry Pi OS (pre-installed)
- **Expected**: 4x-7x performance improvement

### Data (NVMe - Unchanged)
- **Storage**: 1.8TB NVMe (sda1)
- **Mount**: `/cluster-nas`
- **Usage**: 39GB used
- **Safety**: Completely unchanged during migration

### Network
- **IP**: 192.168.254.10 (static)
- **Gateway**: 192.168.254.1
- **DNS**: 127.0.0.1 (local Pi-hole)
- **External**: crtrcooperator.duckdns.org

---

## Critical Services

| Service | Port | Bind | Restart | Data Location |
|---------|------|------|---------|---------------|
| caddy | 80, 443, 8443 | 0.0.0.0 | ~5s | /etc/caddy/ |
| pihole-FTL | 53 | 0.0.0.0 | ~3s | /etc/pihole/ |
| nfs-kernel-server | 2049 | 0.0.0.0 | ~2s | /etc/exports |
| docker | - | - | ~10s | /var/lib/docker |
| atuin-server | 8811 | 192.168.254.10 | ~2s | ~/.local/share/atuin/ |
| semaphore | 3001 | 0.0.0.0 | ~3s | /cluster-nas/services/semaphore/ |
| gotty | 7681 | 0.0.0.0 | ~1s | (no data) |
| n8n | 5678 | 127.0.0.1 | ~15s | /cluster-nas/services/n8n/ |
| n8n-postgres | 5432 | internal | ~5s | /cluster-nas/services/n8n/ |

**Total parallel startup**: ~45 seconds

---

## Questions & Clarifications

### Resolved This Session
✅ Backup directory structure and purpose
✅ Relationship between `etc/`, `backups/`, and `state/`
✅ `etc/` IS the Pi-hole Teleporter export (don't modify)
✅ Migration approaches (minimal vs. comprehensive)
✅ System configuration and service dependencies

### Outstanding (If Any)
- Migration execution date/time
- USB drive readiness verification
- Final pre-migration backup verification

---

## Session Context

**Date**: 2025-10-13
**Focus**: Migration planning and backup organization
**Status**: Planning complete, ready for execution
**Risk Level**: LOW (instant rollback available, data isolated)

---

## Commit Recommendation

```bash
cd ~/Projects/crtr-config

# Add new files
git add docs/MIGRATION-*.md
git add docs/BACKUP-STRUCTURE.md
git add backups/
git add HANDOFF-2025-10-13.md

# Commit
git commit -m "Add migration planning docs and backup structure

- Complete migration guides (comprehensive, minimal downtime, checklist)
- Organized backup directory structure with documentation
- System analysis and service dependency mapping
- Ready for Debian SD → Raspberry Pi OS USB migration

Target: <15 min downtime, instant rollback capability"

# Push
git push
```

---

**Session Complete**: All migration planning and backup organization documents created and ready for execution.

**Handoff Status**: ✅ Complete
**Next Action**: Review migration documents and schedule maintenance window
