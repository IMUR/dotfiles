{
  "repository": {
    "name": "crtr-config",
    "purpose": "Schema-first Infrastructure-as-Code for cooperator node",
    "architecture": "state-driven with automatic config generation",
    "philosophy": "Single source of truth in state/*.yml, everything else is generated"
  },

  "node": {
    "hostname": "cooperator",
    "short_name": "crtr",
    "role": "gateway",
    "ip": {
      "internal": "192.168.254.10",
      "external": "47.155.237.161",
      "ddns": "crtrcooperator.duckdns.org"
    },
    "hardware": {
      "platform": "Raspberry Pi 5",
      "arch": "aarch64",
      "cpu_cores": 4,
      "memory_gb": 16
    }
  },

  "critical_services": {
    "gateway": ["caddy", "pihole-FTL"],
    "infrastructure": ["nfs-kernel-server", "docker"],
    "monitoring": ["atuin-server"],
    "failure_impact": {
      "caddy": "All external access lost",
      "pihole-FTL": "Cluster DNS resolution fails",
      "nfs-kernel-server": "Shared storage inaccessible"
    }
  },

  "state_files": {
    "node.yml": {
      "contains": "Node identity, hardware, OS configuration",
      "changes_affect": ["hostname", "timezone", "system packages"],
      "regenerates": ["docs/REFERENCE.md"]
    },
    "services.yml": {
      "contains": "All service definitions (systemd + docker)",
      "changes_affect": ["systemd units", "docker compose files"],
      "regenerates": ["config/systemd/*.service", "config/docker/*/compose.yml", "docs/SERVICES.md"]
    },
    "domains.yml": {
      "contains": "Domain routing and reverse proxy configuration",
      "changes_affect": ["Caddyfile", "DNS overrides"],
      "regenerates": ["config/caddy/Caddyfile", "config/pihole/local-dns.conf", "docs/SERVICES.md"]
    },
    "network.yml": {
      "contains": "Network configuration, DNS, NFS exports",
      "changes_affect": ["network interfaces", "NFS exports", "DNS settings"],
      "regenerates": ["config/nfs/exports", "docs/REFERENCE.md"]
    }
  },

  "deployment": {
    "entry_point": "./deploy/deploy",
    "phases": {
      "01-base": "OS packages, system configuration",
      "02-storage": "Mount /cluster-nas, configure NFS",
      "03-network": "Network interfaces, DNS, DuckDNS",
      "04-services": "Start systemd services and Docker containers",
      "05-gateway": "Configure Caddy, domain routing",
      "06-verify": "Comprehensive verification"
    },
    "order_constraint": "Storage must complete before services (NFS dependency)",
    "idempotent": true
  },

  "generation": {
    "trigger": "./scripts/generate/regenerate-all.sh",
    "inputs": "state/*.yml",
    "outputs": [
      "config/caddy/Caddyfile",
      "config/pihole/local-dns.conf",
      "config/systemd/*.service",
      "docs/*.md"
    ],
    "validation": "Generated configs validated against live system schemas"
  },

  "workflows": {
    "add_service": {
      "steps": [
        "Edit state/services.yml",
        "Edit state/domains.yml",
        "Run ./deploy/deploy service SERVICE_NAME"
      ],
      "auto_generates": ["Caddyfile entry", "DNS override", "systemd unit (if needed)"]
    },
    "modify_config": {
      "wrong_way": "Edit /etc/caddy/Caddyfile directly",
      "right_way": [
        "Edit state/domains.yml",
        "Run ./scripts/generate/regenerate-all.sh",
        "Run ./deploy/deploy gateway"
      ],
      "rationale": "Keeps state and system in sync"
    },
    "disaster_recovery": {
      "command": "./deploy/deploy all",
      "time": "20-30 minutes",
      "result": "Identical system from state files"
    }
  },

  "troubleshooting": {
    "knowledge_base": ".meta/ai/knowledge.yml",
    "query_by": ["symptom", "service_name", "error_message"],
    "provides": ["root_cause", "state_fix", "commands", "verification"],
    "structure": "Structured YAML for AI parsing"
  },

  "service_patterns": {
    "binding": {
      "127.0.0.1": {
        "use_case": "Services proxied via Caddy",
        "examples": ["n8n:5678", "semaphore:3000", "gotty:7681"],
        "rationale": "Defense in depth - only Caddy exposed externally"
      },
      "0.0.0.0": {
        "use_case": "Services with cluster-wide or external access",
        "examples": ["DNS:53", "atuin:8811", "NFS:2049", "Caddy:80/443"],
        "rationale": "Required for gateway/infrastructure role"
      }
    },
    "reverse_proxy_types": {
      "standard": "Basic HTTP reverse proxy",
      "websocket": "WebSocket support (headers: Upgrade, Connection)",
      "sse": "Server-Sent Events (flush_interval: -1)",
      "https_backend": "HTTPS backend with TLS skip"
    }
  },

  "validation": {
    "schema_validation": "./tests/test-state.sh",
    "generation_testing": "./tests/test-generation.sh",
    "deployment_testing": "./tests/test-deployment.sh",
    "run_before": "committing state changes"
  },

  "storage": {
    "paths": {
      "/cluster-nas": {
        "device": "/dev/sda1",
        "type": "xfs",
        "size": "1.8TB",
        "exported_to": "192.168.254.0/24",
        "purpose": "Shared cluster storage"
      },
      "/": {
        "device": "/dev/sdb2",
        "type": "ext4",
        "size": "931GB",
        "purpose": "System root"
      }
    },
    "service_data_location": "/cluster-nas/services/",
    "backup_location": "/cluster-nas/backups/"
  },

  "external_access": {
    "domain": "*.ism.la",
    "dns_provider": "GoDaddy",
    "dynamic_dns": "DuckDNS (crtrcooperator.duckdns.org)",
    "cname_pattern": "*.ism.la → crtrcooperator.duckdns.org → 47.155.237.161",
    "port_forwarding": {
      "22/tcp": "SSH",
      "80/tcp": "HTTP (Caddy)",
      "443/tcp": "HTTPS (Caddy)"
    }
  },

  "dns_architecture": {
    "external_resolution": "*.ism.la → GoDaddy → CNAME → DuckDNS → Public IP",
    "internal_resolution": "*.ism.la → Pi-hole → Local override → 192.168.254.10",
    "split_horizon": true,
    "override_file": "/etc/dnsmasq.d/02-custom-local-dns.conf"
  },

  "ai_assistance": {
    "context_files": [
      ".meta/ai/context.json (this file)",
      ".meta/ai/knowledge.yml (troubleshooting)",
      ".meta/ai/workflows.yml (common workflows)"
    ],
    "query_methods": [
      "symptom → root cause → solution",
      "service_name → configuration → state_location",
      "workflow_name → steps → commands"
    ],
    "state_modification": "Always suggest state/*.yml changes, never direct config edits",
    "verification": "Always include verification steps in suggestions"
  },

  "common_operations": {
    "view_services": "cat state/services.yml | yq '.services'",
    "view_domains": "cat state/domains.yml | yq '.domains'",
    "validate_state": "./tests/test-state.sh",
    "regenerate_configs": "./scripts/generate/regenerate-all.sh",
    "deploy_all": "./deploy/deploy all",
    "deploy_service": "./deploy/deploy service SERVICE_NAME",
    "verify_system": "./deploy/verify/verify-all.sh"
  },

  "meta": {
    "version": "1.0.0",
    "last_updated": "2025-10-07",
    "structure": "JSON for AI parsing",
    "purpose": "Provide complete operational context to AI assistants",
    "usage": "AI should query this file to understand repository structure and operations"
  }
}
