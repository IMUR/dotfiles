#!/usr/bin/env bash
# Main SSOT Command Wrapper
# Single command to manage Infrastructure Single Source of Truth

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

show_help() {
    cat << EOF
Infrastructure SSOT Manager

Usage: ssot <command> [options]

Commands:
  discover      Auto-discover current infrastructure state
  validate      Validate SSOT against live infrastructure
  diff          Show differences between SSOT and current state
  update        Alias for discover (updates SSOT with current state)
  status        Show SSOT status and last validation time
  help          Show this help message

Examples:
  ssot discover               # Generate SSOT from live infrastructure
  ssot validate               # Check if SSOT matches reality
  ssot status                 # Show current SSOT status

Files:
  infrastructure-truth.yaml   # Single source of truth
  cache/validation-report.txt # Last validation results
  cache/last-validation-*.txt # Validation metadata

The SSOT (Single Source of Truth) is generated from:
  - GoDaddy DNS API (requires .env.godaddy)
  - SSH queries to all cluster nodes
  - Docker container status
  - Systemd service status
EOF
}

cmd_discover() {
    echo -e "${BLUE}Running infrastructure discovery...${NC}"
    "$SCRIPT_DIR/discover-truth.sh"
}

cmd_validate() {
    echo -e "${BLUE}Validating SSOT against live infrastructure...${NC}"
    "$SCRIPT_DIR/validate-truth.sh"
}

cmd_status() {
    if [[ ! -f "$SCRIPT_DIR/infrastructure-truth.yaml" ]]; then
        echo -e "${YELLOW}⚠  SSOT not yet generated${NC}"
        echo "Run: ssot discover"
        exit 1
    fi

    echo "Infrastructure SSOT Status"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # Last discovered
    last_disc=$(grep "last_discovered:" "$SCRIPT_DIR/infrastructure-truth.yaml" | awk '{print $2}' | tr -d '"')
    echo -e "${GREEN}Last discovered:${NC} $last_disc"

    # Last validated
    if [[ -f "$SCRIPT_DIR/cache/last-validation-time.txt" ]]; then
        last_val=$(cat "$SCRIPT_DIR/cache/last-validation-time.txt")
        echo -e "${GREEN}Last validated:${NC} $last_val"
    else
        echo -e "${YELLOW}Last validated:${NC} Never"
    fi

    # Validation hash
    if [[ -f "$SCRIPT_DIR/cache/last-validation-hash.txt" ]]; then
        val_hash=$(cat "$SCRIPT_DIR/cache/last-validation-hash.txt")
        echo -e "${GREEN}Validation hash:${NC} ${val_hash:0:20}..."
    fi

    # Node count
    node_count=$(grep -c "^  [a-z]*:$" "$SCRIPT_DIR/infrastructure-truth.yaml" || echo "0")
    echo -e "${GREEN}Nodes tracked:${NC} $node_count"

    # DNS records
    dns_count=$(grep "type:" "$SCRIPT_DIR/infrastructure-truth.yaml" | grep -v "# type:" | wc -l)
    echo -e "${GREEN}DNS records:${NC} $dns_count"

    echo ""
    echo "SSOT file: $SCRIPT_DIR/infrastructure-truth.yaml"
}

cmd_diff() {
    echo "Not yet implemented"
    echo "Use: ssot validate"
}

# Main command router
case "${1:-help}" in
    discover|update)
        cmd_discover
        ;;
    validate)
        cmd_validate
        ;;
    status)
        cmd_status
        ;;
    diff)
        cmd_diff
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
