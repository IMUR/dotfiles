---
# Network configuration for cooperator
# Schema: .meta/schemas/network.schema.json
# Source: COOPERATOR-ASPECTS.md

network:
  interface:
    name: eth0
    ip: 192.168.254.10/24
    gateway: 192.168.254.1
    mac: 88:A2:9E:07:04:22

  dns:
    client:
      nameserver: 127.0.0.1
      config_file: /etc/resolv.conf
    server:
      type: pihole
      bind: 0.0.0.0
      port: 53
      upstream:
        - 1.1.1.1
        - 1.0.0.1
      local_overrides:
        - domain: dns.ism.la
          ip: 192.168.254.10
        - domain: mng.ism.la
          ip: 192.168.254.10
        - domain: env.ism.la
          ip: 192.168.254.10
        - domain: smp.ism.la
          ip: 192.168.254.10
        - domain: ssh.ism.la
          ip: 192.168.254.10
        - domain: n8n.ism.la
          ip: 192.168.254.10
        - domain: sch.ism.la
          ip: 192.168.254.10
        - domain: cht.ism.la
          ip: 192.168.254.10
        - domain: acn.ism.la
          ip: 192.168.254.10
        - domain: api.ism.la
          ip: 192.168.254.10
        - domain: dtb.ism.la
          ip: 192.168.254.10
        - domain: mcp.ism.la
          ip: 192.168.254.10
        - domain: btr.ism.la
          ip: 192.168.254.10
      config_dir: /etc/pihole/

  ddns:
    # Automated dynamic DNS updates via cron (*/5 * * * *)
    # Script syncs multiple DuckDNS and GoDaddy domains when public IP changes
    provider: duckdns
    domains:
      - crtrcooperator.duckdns.org  # Maps to ism.la
      - colaboratory.duckdns.org    # Maps to rtr.dev
    token: dd3810d4-6ea3-497b-832f-ec0beaf679b3
    update_script: ~/duckdns/duck.sh
    cron_schedule: "*/5 * * * *"
    log_file: ~/duckdns/duck.log
    ip_cache: ~/duckdns/last-ip.txt
    # GoDaddy sync configuration (credentials stored in Infisical)
    godaddy:
      domains:
        - ism.la     # Primary cluster domain
        - rtr.dev    # Secondary domain
      record_type: A
      record_name: "@"
      ttl: 3600
      credentials_source: infisical
      infisical_path: /godaddy
      infisical_env: prod
      infisical_config: ~/Projects/crtr-config/.infisical.json
      # Sync behavior: Only updates GoDaddy when IP actually changes (cached comparison)

  external:
    public_ip: 47.154.24.167  # Auto-synced to DuckDNS + GoDaddy ism.la
    ddns_hostname: crtrcooperator.duckdns.org
    port_forwards:
      - port: 22
        protocol: tcp
        destination: 192.168.254.10:22
        description: SSH
      - port: 80
        protocol: tcp
        destination: 192.168.254.10:80
        description: HTTP
      - port: 443
        protocol: tcp
        destination: 192.168.254.10:443
        description: HTTPS

  cluster:
    subnet: 192.168.254.0/24
    nodes:
      cooperator: 192.168.254.10  # crtr - Debian 13 (ARM64) - Gateway/DNS/NFS
      zerouter: 192.168.254.11    # zrtr - Kali Linux (ARMv7) - Router
      projector: 192.168.254.20   # prtr - Debian 13 (x86_64) - Compute
      director: 192.168.254.30    # drtr - Debian 13 (x86_64) - Compute
      terminator: 192.168.254.40  # trtr - macOS - Control/Development
    devices:
      barter: 192.168.254.123     # ESP32-S3 - Machine controller (Projector/Director)

  dhcp:
    enabled: true
    server: pihole
    range_start: 192.168.254.50
    range_end: 192.168.254.200
    lease_time: 24h

  dhcp_reservations:
    gateway: 192.168.254.254
    reservations:
      - hostname: cooperator
        mac: "88:a2:9e:07:04:22"
        ip: 192.168.254.10
        type: raspberry-pi-5
        notes: "Edge services node, static IP + DHCP reservation"
      - hostname: projector
        mac: "40:b0:76:44:7b:f3"
        ip: 192.168.254.20
        type: windows-pc
        notes: "Windows host running WSL2"
      - hostname: writer
        mac: "40:b0:76:44:7b:f2"
        ip: 192.168.254.21
        type: windows-wsl
        notes: "WSL2 instance on projector"
      - hostname: director
        mac: "80:fa:5b:74:f2:9e"
        ip: 192.168.254.30
        type: x86_64
        notes: "Compute node"
      - hostname: terminator
        mac: "2c:ca:16:81:44:7b"
        ip: 192.168.254.40
        type: macos
        notes: "Control/Development workstation"
      - hostname: zerouter
        mac: "2c:cf:67:b2:02:f2"
        ip: 192.168.254.11
        type: raspberry-pi
        notes: "Kali Linux router node"
      - hostname: raspberrypi
        mac: "b8:27:eb:60:f5:a8"
        ip: 192.168.254.12
        type: raspberry-pi
        notes: "Additional Pi node"
      - hostname: barter
        mac: "30:ed:a0:2a:24:64"
        ip: 192.168.254.123
        type: esp32-s3
        notes: "Machine controller, static IP + DHCP reservation"

  storage:
    # Physical storage devices on cooperator
    devices:
      - name: sda
        type: usb
        model: "USB 3.2.2 FD"
        serial: 072152591C501870
        size: 931.5GB
        performance: 354MB/s
        mount: /
        filesystem: ext4
        purpose: boot-disk
        notes: "Active boot drive"

      - name: mmcblk0
        type: flash
        model: "SD FG8Y7"
        serial: "0x70f856ea"
        size: 955GB
        performance: 91MB/s
        mount: /media/crtr/fortress
        filesystem: xfs
        uuid: 3f865e82-2d38-4534-8e20-d61750d4fee8
        purpose: samba-nas
        notes: "Fortress - High-performance cluster storage (fastest for NAS)"

      - name: sdb
        type: hdd
        model: "Hitachi HDS723020BLA642"
        serial: MN3220F31TWV4E
        size: 1.8TB
        performance: 14MB/s
        mount: unmounted
        purpose: raid-backup
        notes: "Designated for RAID1 with sdd (slower drive)"

      - name: sdc
        type: hdd
        model: "SSK Storage"
        serial: DD564198838B8
        size: 1.8TB
        performance: 35MB/s
        mount: /media/crtr/crtr-data1
        filesystem: xfs
        purpose: archive
        notes: "Former NAS drive, now available for archive/spare"

      - name: sdd
        type: hdd
        model: "HGST HUS724020ALE640"
        serial: PK1134P6KXAWWW
        size: 1.8TB
        performance: 35MB/s
        mount: unmounted
        purpose: raid-backup
        notes: "Designated for RAID1 with sdb"

  samba:
    # Fortress - High-performance cluster storage (955GB flash)
    server_role: standalone
    workgroup: COLAB
    protocol: SMB3  # SMB3 for encryption, performance, and security
    config_file: /etc/samba/smb.conf
    shares:
      - name: fortress
        path: /media/crtr/fortress
        device: /dev/mmcblk0p1
        filesystem: xfs
        size: 955GB
        performance: 91MB/s sequential read
        uuid: 3f865e82-2d38-4534-8e20-d61750d4fee8
        comment: "Fortress - High-Performance Cluster Storage (Docker, Data, Cache)"
        access: read-write
        valid_users: "@cluster"
        create_mask: "0775"
        directory_mask: "0775"
        force_group: cluster
        vfs_objects:
          - acl_xattr
        subdirs:
          - docker   # Container volumes and images
          - data     # Application data
          - cache    # Temporary/cache data
    credentials:
      source: infisical
      path: /samba
      secret_name: COLAB_NAS_SAMBA_PASSWORD
      env: prod
    network:
      hosts_allow:
        - 192.168.254.0/24  # Local network
        - 100.64.0.0/16     # Headscale mesh
        - 127.0.0.1         # Localhost
    mount_points:
      linux: "//cooperator.colab/fortress → /mnt/fortress"
      windows: "\\\\cooperator.colab\\fortress → Z:\\"
      macos: "smb://cooperator.colab/fortress → /Volumes/fortress"
